---
title: 流程编排那些事
author: daviswujiahao
date: 2023-06-06 11:33:00 +0800
categories: [技术]
tags: [流程编排,开源调研]
math: true
mermaid: true
---

[TOC]

# 名词释义

## 何为编排

在计算机科学和软件工程中，"编排"（Orchestration）是指协调和管理多个独立组件或服务，以实现特定的业务流程或工作流程。它涉及到在一个整体系统中将各个组件或服务按照预定的顺序和方式进行调度、执行和交互。编排通常用于构建分布式系统、集成不同的服务或微服务，并实现复杂的业务逻辑和流程。编排的目标是通过协调和组织各个组件或服务之间的交互，以实现特定的功能和业务需求。
编排可以涉及以下几个方面：

1. 流程定义：编排定义了业务流程或工作流程的步骤、顺序和条件。它描述了系统中各个组件或服务之间的依赖关系和交互方式。
2. 调度和协调：编排负责根据流程定义，调度和协调各个组件或服务的执行。它确保在正确的时间和顺序下启动和运行每个组件，以满足整体流程的要求。
3. 数据传递和转换：编排负责管理数据在各个组件或服务之间的传递和转换。它确保正确的数据被传递给需要的组件，并处理数据格式转换和映射等。
4. 错误处理和故障恢复：编排需要处理可能发生的错误和故障情况。它可以包括错误处理、重试机制、故障恢复策略等，以确保整个流程的可靠性和稳定性。
编排可以使用不同的工具和技术来实现，例如工作流引擎、编排引擎、容器编排平台等。这些工具提供了一种便捷的方式来定义、执行和管理复杂的业务流程或工作流程。
总之，编排是一种在分布式系统或微服务架构中协调和管理多个组件或服务的方式，以实现特定的业务逻辑和流程。它涉及到定义流程、调度执行、数据传递、错误处理等任务，以实现系统的整体功能和要求。

## 编排的类型

- 应用编排（Application Orchestration）：应用编排是指在应用程序级别对多个组件、服务或模块进行协调和管理，以实现特定的应用程序功能或业务流程。它涉及到在应用程序中定义和管理组件之间的依赖关系、交互方式和执行顺序。应用编排通常用于构建复杂的企业应用程序，协调不同的服务、模块和组件来实现整体功能。
服务编排（Service Orchestration）：服务编排是指在服务级别对多个独立的服务进行协调和管理，以实现特定的业务流程或工作流程。它涉及到定义和管理服务之间的依赖关系、交互方式和执行顺序，以满足业务需求。服务编排通常用于构建分布式系统或微服务架构，将各个服务按照业务流程组织起来，并通过编排引擎或工作流引擎来实现服务之间的交互和协调。
- 容器编排（Container Orchestration）：容器编排是指在容器级别对多个容器进行协调和管理，以实现高效的部署、伸缩和运维。它涉及到管理容器的创建、启动、停止、伸缩、网络配置等，以实现容器化应用程序的管理和调度。容器编排工具（如 Kubernetes）提供了自动化容器管理的能力，使得在分布式环境中大规模运行和管理容器化应用程序变得更加简单和可靠。
- 应用编排、服务编排和容器编排是针对不同层级的编排实践。应用编排和服务编排关注在应用程序或服务级别的组件协调和管理，而容器编排关注在容器级别的部署、伸缩和运维。这些编排实践都旨在提高系统的可靠性、可伸缩性和效率，并简化复杂系统的管理和运维工作。
  
除了容器编排有现成的开源工具实现，其他的应用编排和服务编排均需要系统按照业务需求自行实现，可以把服务编排作为应用里的一部分看待，也可以把服务编排当成服务总线型项目功能的流程设计的一部分。而应用的编排可以理解为应用内组件或者模块之间的流程设计，粒度要比服务的粒度大一点。

  对账的双方系统的称呼，对账对的就是数据，数据源的提供方，一方叫做左方，另一方叫做右方。

- 差异

​       对账过程中左/右两方数据源的差异，分为左单边，右单边，金额不等。

​       左单边：左方账单比右方账单多出的账单记录

​       右单边：右方账单比左方账单多出的账单记录

​       金额不等：左、右两方账单文件中金额不一致的账单记录

- 聚合对账

  以对账单号聚合将金额求和后以求和的金额进行对账

- 滚动对账

  判断新产生的右单边(左单边)记录和历史产生的左单边(右单边)是否可以对平，主要解决账单记录跨天导致的差异问题。

# 为什么要对账

- 对账是信息在各个系统(尤其是整个支付系统)流转过程中，最后一道安全防线，是交易流程中重要的纠错机制。
- 避免意外和人为错误发生

​     （1）意外错误：网络稳定性、内部系统（订单、支付、风控）的健壮性。

​     （2）人为错误：人为操作失误、上游、内部恶意修改等行为。

- 对账是财务流程中重要的一环，特别是当交易量上万 / 天，人工手动对账毫无可能时，为了避免订单差错越积越多，变成糊涂账，我们需要日日结清，对账也是保证公司财务健康的必要环节。

# 对账核心逻辑

## 方案一：我要造轮子(Java版伪代码)

```java
/**
 左方文件:
 业务单号,金额,完成时间,状态
 key001, 10, 2022-11-01 00:01, 0
 key001, 11, 2022-11-01 01:01, 0
 key003, 10, 2022-11-01 02:01, 0
 key002, 10, 2022-11-01 03:01, 0
**/
inStream leftData = read("左方账单文件路径");
/**
 右方文件:
 业务单号,金额,完成时间
 key001, 10, 2022-11-01 00:01
 key002, 10, 2022-11-01 03:01
 key004, 10, 2022-11-01 03:01
**/
inStream rightData = read("右方账单文件路径");

// 根据业务单号对左/右账单文件里的账单记录进行从小到大排序
inStream leftDataSoft = sort(leftData);
inStream rightDataSoft = sort(rightData);

// 双指针遍历排完序后的左/右两方的账单文件记录
do {
  leftRow = readRow(leftDataSoft, leftIdx);
  rightRow = readRow(leftDataSoft, rightIdx);
  // 注意非空处理
  if (leftRow[0] == rightRow[0]) {
    // 两边业务单号相同
    if (leftRow[1] == rightRow[0]) {
      // leftRow 和 leftRow 为对平记录
    } else {
      // leftRow 和 leftRow 为金额不等的差异记录
    }
    leftIdx++;
    rightIdx++;
  } else if (leftRow[0] < rightRow[0]) {
    // leftRow 为左单边的差异记录
    leftIdx++;
  } else {
    // rightIdx 为右单边的差异记录
    rightIdx++;
  }
} while (leftRow != null || rightRow != null);

// 汇总对平记录、金额不等记录、左单边记录、右单边记录
```

## 方案二：我要骑自行车(shell 脚本)

```shell

 左方文件: left.csv.2022-11-01
 业务单号,金额,完成时间,状态
 key001, 10, 2022-11-01 00:01, 0
 key001, 11, 2022-11-01 01:01, 0
 key003, 10, 2022-11-01 02:01, 0
 key002, 10, 2022-11-01 03:01, 0

 右方文件: right.csv.2022-11-01
 业务单号,金额,完成时间
 key001, 10, 2022-11-01 00:01
 key002, 10, 2022-11-01 03:01
 key004, 10, 2022-11-01 03:01
 
 # 拼接唯一键：业务单号+金额，清晰为新文件
 awk -F ', ' '{printf "%s_%s\n",$1,$2}' left.csv.2022-11-01 > left_uniq
 awk -F ', ' '{printf "%s_%s\n",$1,$2}' right.csv.2022-11-01 > right_uniq
 
 # 排序
 sort left_uniq > left_uniq_sort
 sort right_uniq > right_uniq_sort
 
 # 文件对比
 comm left_uniq_sort right_uniq_sort > result.csv
 # result.csv：
 # 第一列为 左单边(或者金额不一致)
 # 第二列为有单边(或者金额不一致)
 # 第三列为对平数据
```

## 方案三：我要坐飞机(hive)

```sql
 /**
 左方文件: left.csv.2022-11-01
 业务单号,金额,完成时间,状态
 key001, 10, 2022-11-01 00:01, 0
 key001, 11, 2022-11-01 01:01, 0
 key003, 10, 2022-11-01 02:01, 0
 key002, 10, 2022-11-01 03:01, 0

 右方文件: right.csv.2022-11-01
 业务单号,金额,完成时间
 key001, 10, 2022-11-01 00:01
 key002, 10, 2022-11-01 03:01
 key004, 10, 2022-11-01 03:01
**/

# csv -> mysql/hive
# left_data_table/right_data_table:
# keyNo, amount, extra
left.csv.2022-11-01 >> left_data_table
right.csv.2022-11-01 >> right_data_table

# 执行对账sql，获取对账结果
insert into check_result 
(
  select
    t1.keyNo as leftKeyNo,
    t1.amount as leftAmount,
    t2.keyNo as rightKeyNo,
    t2.amount as rightAmount
from
    (
        select
            keyNo as keyNo,
            sum(amount) as amount
        from
            left_data_table
        group by keyNo
    ) as t1 
    full outer join 
    (
        select
            keyNo as keyNo,
            sum(amount) as amount
        from
            right_data_table
        group by keyNo
    ) as t2
    on
    t1.keyNo = t2.keyNo
 );
 
 # 对平结果
 select * from check_result where leftKeyNo != null && rightKeyNo != null && leftAmount = rightAmount;
 # 左单边
 select * from check_result where leftKeyNo != null && rightKeyNo = null;
 # 有单边
 select * from check_result where leftKeyNo = null && rightKeyNo != null;
 # 金额不等
 select * from check_result where leftKeyNo != null && rightKeyNo != null && leftAmount != rightAmount;
```

## 方案对比

| 方案名称   | 实现复杂度 | 是否可并行 | 执行效率 | 支持聚合对账 | 额外存储成本 | 依赖基础设施 |
| :--------- | ---------- | ---------- | -------- | ------------ | ------------ | ------------ |
| 纯Java代码 | 高         | 否         | 低       | 支持         | 否           | 否           |
| shell脚本  | 中         | 否         | 中       | 不支持       | 否           | 否           |
| hive       | 低         | 是         | 高       | 支持         | 是           | 是           |

# 对账平台

## 需求

对账的过程：触发对账任务 ->  拉取左/右两边对账数据  -> 执行对账产生结果(对平&&差异数据) -> 对账结果处理

- 任务什么时候执行？拉取哪几个数据源的数据？
- 对账方数据源的获取方式，有哪些字段，是否需要过滤，是否需要进行字段处理
- 产生差异怎么办？
- 对平数据怎么处理？

## 功能模块图

![未命名绘图.drawio](https://github.com/davisjiahao/davisjiahao.github.io/blob/main/_data/assets/img/功能模块图.png?raw=true)  

### 任务管理

- 任务调度：定时调度执行对账任务
- 任务配置：调度配置，数据源配置、差异管理配置、对平数据管理配置
- 任务监控：异常任务执行记录监控报警(执行失败/执行超时/漏执行)

### 数据源管理

- 字段映射：各业务账单数据的字段映射和解析
- 清洗配置：各业务账单数据的过滤配置和
- 数据拉取：根据各业务账单数据类型(sftp/hive)，拉取账单数据

### 对平数据管理

- 数据存储：持久化存储对平数据
- 结果通知：每次对账任务产生的对平汇总数据的通知
- 数据推送：接口/mq通知每次对平数据的获取方式

### 差异管理

- 滚动对账：对账过程中新产生的差异记录和历史差异记录的对账校验，尝试自动修复历史差异
- 差异回调：接口/mq通知每次产生的差异记录
- 差异回调修单：接口通知每次产生的差异记录，被调用方返回正确的账单数据，进行对账校验，尝试自动修复差异
- 手动修单：人工补上传有问题那方的账单数据，进行差异修复
- 差异通知：每次对账任务产生的差异汇总数据的通知
- 差异监控：当日扫描T-2日还未对平的差异记录，进行报警处理

## 现有系统架构图

![架构图](https://github.com/davisjiahao/davisjiahao.github.io/blob/main/_data/assets/img/架构图.png?raw=true)

## 现有系统核心逻辑实现

### 对账核心

```java
// shell + java代码
// awk数据过滤和清洗 -> 重定向合并多个对账文件 -> sort命令排序 -> Java代码双指针进行对账
```

### 分阶段流程编排

将对账流程抽象为【数据准备】【对账处理】【差异处理】【结果处理】4个阶段，每个阶段再细分为多个处理节点，各个处理节点可配置多个处理插件，进行实际的处理流程。

![对账流程](https://github.com/davisjiahao/davisjiahao.github.io/blob/main/_data/assets/img/对账流程.png?raw=true)

# 讨论

对账流程的优化？
是否有必要自己实现一套流程编排代码？
任务调度框架的选择？

